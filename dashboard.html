<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainer Performance Dashboard - Educate!</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
        
        /* Header */
        .header { background: #1e293b; padding: 16px 24px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .header h1 { color: #f97316; font-size: 24px; }
        .header-subtitle { color: #94a3b8; font-size: 14px; }
        .header-stats { display: flex; gap: 16px; }
        .stat-card { background: #0f172a; padding: 12px 16px; border-radius: 8px; border-left: 4px solid; min-width: 100px; }
        .stat-value { font-size: 24px; font-weight: bold; }
        .stat-label { font-size: 12px; color: #94a3b8; }
        
        /* Main Layout */
        .main-container { display: flex; height: calc(100vh - 90px); }
        
        /* Sidebar */
        .sidebar { width: 300px; background: #1e293b; border-right: 1px solid #334155; display: flex; flex-direction: column; overflow: hidden; }
        .filter-section { padding: 16px; border-bottom: 1px solid #334155; }
        .filter-title { font-size: 12px; color: #94a3b8; text-transform: uppercase; margin-bottom: 12px; }
        .filter-select { width: 100%; padding: 10px 12px; margin-bottom: 8px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: #e2e8f0; font-size: 14px; }
        .clear-btn { width: 100%; padding: 8px; background: transparent; border: 1px solid #475569; border-radius: 6px; color: #94a3b8; cursor: pointer; margin-top: 4px; }
        .clear-btn:hover { background: #334155; }
        
        /* Quick Insights Toggle - Compact for Mobile */
        .quick-insights-toggle { padding: 10px 12px; background: #0f172a; border-bottom: 1px solid #334155; cursor: pointer; display: none; }
        .quick-insights-header { display: flex; justify-content: space-between; align-items: center; }
        .quick-insights-title { font-size: 12px; color: #f97316; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .quick-insights-summary { display: flex; gap: 12px; align-items: center; }
        .quick-stat { text-align: center; }
        .quick-stat-value { font-size: 16px; font-weight: bold; color: #f97316; }
        .quick-stat-label { font-size: 9px; color: #64748b; }
        .toggle-arrow { color: #64748b; font-size: 12px; transition: transform 0.2s; }
        .toggle-arrow.expanded { transform: rotate(180deg); }
        .quick-insights-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; background: #0f172a; }
        .quick-insights-content.expanded { max-height: 250px; overflow-y: auto; }
        .quick-insights-details { padding: 12px; font-size: 12px; }
        .quick-insight-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid #1e293b; }
        .quick-insight-item:last-child { border-bottom: none; }
        .view-full-btn { display: block; width: calc(100% - 24px); margin: 8px 12px; padding: 8px; background: #334155; border: 1px solid #475569; border-radius: 6px; color: #94a3b8; cursor: pointer; font-size: 11px; text-align: center; }
        .view-full-btn:hover { background: #475569; color: #e2e8f0; }
        
        /* Trainer List */
        .trainer-list { flex: 1; overflow-y: auto; padding: 16px; }
        .list-title { font-size: 14px; color: #94a3b8; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .trainer-card { background: #0f172a; padding: 12px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid #6b7280; cursor: pointer; transition: all 0.2s; }
        .trainer-card:hover, .trainer-card.selected { background: #334155; transform: translateX(4px); }
        .trainer-card-name { font-weight: 600; margin-bottom: 4px; font-size: 14px; }
        .trainer-card-meta { font-size: 11px; color: #94a3b8; }
        .trainer-card-score { margin-top: 6px; font-size: 16px; font-weight: bold; }
        
        /* Main Panel */
        .main-panel { flex: 1; padding: 24px; overflow-y: auto; }
        .placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; color: #64748b; }
        
        /* View Header */
        .view-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #1e293b; border-radius: 12px; margin-bottom: 24px; }
        .view-title { font-size: 24px; font-weight: bold; margin-bottom: 4px; }
        .view-subtitle { color: #94a3b8; font-size: 14px; }
        .score-circle { width: 100px; height: 100px; border-radius: 50%; background: #0f172a; border: 4px solid #f97316; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .score-circle-value { font-size: 28px; font-weight: bold; }
        .score-circle-label { font-size: 11px; color: #94a3b8; }
        
        /* Tabs */
        .tabs { display: flex; gap: 8px; margin-bottom: 24px; }
        .tab { padding: 10px 20px; background: #1e293b; border: none; border-radius: 8px; color: #94a3b8; cursor: pointer; font-size: 14px; }
        .tab.active { background: #f97316; color: white; }
        .tab:hover:not(.active) { background: #334155; }
        
        /* Tab Content */
        .tab-content { background: #1e293b; border-radius: 12px; padding: 20px; }
        .section { margin-bottom: 24px; }
        .section:last-child { margin-bottom: 0; }
        .section-title { font-size: 16px; color: #f97316; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .stats-grid-item { background: #0f172a; padding: 16px; border-radius: 8px; text-align: center; }
        .stats-grid-value { font-size: 28px; font-weight: bold; color: #f97316; }
        .stats-grid-label { font-size: 12px; color: #94a3b8; margin-top: 4px; }
        
        /* Performance Distribution */
        .distribution-bar { display: flex; height: 24px; border-radius: 6px; overflow: hidden; margin-bottom: 12px; }
        .distribution-segment { display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; color: white; }
        .distribution-legend { display: flex; gap: 16px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; }
        .legend-dot { width: 12px; height: 12px; border-radius: 3px; }
        
        /* Competency Bars */
        .competency-item { display: grid; grid-template-columns: 180px 1fr 60px; align-items: center; gap: 12px; margin-bottom: 12px; }
        .competency-label { font-size: 13px; }
        .competency-bar { height: 8px; background: #0f172a; border-radius: 4px; overflow: hidden; }
        .competency-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .competency-score { text-align: right; font-weight: bold; }
        
        /* Trainer Rankings Table */
        .rankings-table { width: 100%; }
        .rankings-header, .rankings-row { display: grid; grid-template-columns: 40px 1fr 80px 80px 100px; gap: 12px; padding: 10px 0; align-items: center; }
        .rankings-header { border-bottom: 1px solid #334155; color: #94a3b8; font-weight: 600; font-size: 12px; }
        .rankings-row { border-bottom: 1px solid #1e293b; font-size: 13px; cursor: pointer; }
        .rankings-row:hover { background: #334155; }
        .rank-badge { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; }
        .rank-1 { background: #fbbf24; color: #1e293b; }
        .rank-2 { background: #94a3b8; color: #1e293b; }
        .rank-3 { background: #cd7f32; color: white; }
        .rank-other { background: #334155; color: #94a3b8; }
        
        /* Comparison Cards */
        .comparison-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .comparison-card { background: #0f172a; padding: 16px; border-radius: 8px; }
        .comparison-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .comparison-icon { font-size: 20px; }
        .comparison-label { font-size: 14px; color: #94a3b8; }
        .comparison-scores { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .comparison-main-score { font-size: 28px; font-weight: bold; }
        .comparison-vs { color: #64748b; }
        .comparison-compare-score { font-size: 20px; color: #94a3b8; }
        .comparison-bar-bg { position: relative; height: 8px; background: #334155; border-radius: 4px; margin-bottom: 12px; }
        .comparison-bar-fill { height: 100%; border-radius: 4px; }
        .comparison-marker { position: absolute; top: -4px; width: 4px; height: 16px; background: white; border-radius: 2px; transform: translateX(-50%); }
        .comparison-meta { display: flex; justify-content: space-between; font-size: 12px; color: #94a3b8; }
        
        /* Insights Cards */
        .insight-card { padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid; }
        .insight-card.strength { background: #064e3b33; border-left-color: #10b981; }
        .insight-card.warning { background: #78350f33; border-left-color: #f59e0b; }
        .insight-card.danger { background: #7f1d1d33; border-left-color: #ef4444; }
        .insight-card.info { background: #1e3a5f; border-left-color: #3b82f6; }
        .insight-title { font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .insight-title.strength { color: #10b981; }
        .insight-title.warning { color: #f59e0b; }
        .insight-title.danger { color: #ef4444; }
        .insight-title.info { color: #60a5fa; }
        .insight-text { font-size: 14px; color: #cbd5e1; line-height: 1.6; }
        
        /* Action Plan */
        .action-step { display: flex; gap: 16px; background: #0f172a; padding: 16px; border-radius: 8px; margin-bottom: 12px; }
        .action-step.immediate { border: 1px solid #ef4444; }
        .action-step.short-term { border: 1px solid #f59e0b; }
        .step-number { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .step-content { flex: 1; }
        .step-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .step-priority { font-weight: 700; font-size: 12px; }
        .step-timeline { font-size: 12px; color: #94a3b8; }
        .step-focus { font-weight: 600; margin-bottom: 8px; }
        .step-diagnosis { font-size: 14px; color: #cbd5e1; margin-bottom: 12px; }
        .step-actions { background: #1e293b; padding: 12px; border-radius: 6px; margin-bottom: 8px; }
        .step-actions-title { font-size: 12px; color: #f97316; margin-bottom: 8px; }
        .step-actions-list { margin: 0; padding-left: 20px; font-size: 14px; color: #e2e8f0; }
        .step-actions-list li { margin-bottom: 6px; }
        .coaching-tip { background: #1e3a5f; padding: 10px 12px; border-radius: 6px; font-size: 13px; margin-bottom: 8px; }
        .coaching-tip-label { color: #60a5fa; }
        .coaching-tip-text { color: #cbd5e1; }
        .success-metric { font-size: 13px; color: #10b981; }
        
        /* Urgency Badge */
        .urgency-badge { display: inline-block; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 14px; color: white; }
        
        /* History Table */
        .history-header, .history-row { display: grid; grid-template-columns: 100px 80px 1fr 80px; gap: 12px; padding: 8px 0; }
        .history-header { border-bottom: 1px solid #334155; color: #94a3b8; font-weight: 600; font-size: 13px; }
        .history-row { border-bottom: 1px solid #1e293b; font-size: 14px; }
        
        /* Loading & Error */
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .spinner { width: 40px; height: 40px; border: 4px solid #334155; border-top-color: #f97316; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; color: #94a3b8; }
        .error-container { text-align: center; padding: 40px; }
        .retry-btn { margin-top: 16px; padding: 12px 24px; background: #f97316; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
        
        /* Colors */
        .score-exceptional { color: #059669; } .score-strong { color: #10b981; } .score-adequate { color: #f59e0b; } .score-developing { color: #f97316; } .score-needs-support { color: #ef4444; }
        .bg-exceptional { background: #059669; } .bg-strong { background: #10b981; } .bg-adequate { background: #f59e0b; } .bg-developing { background: #f97316; } .bg-needs-support { background: #ef4444; }
        .border-exceptional { border-left-color: #059669; } .border-strong { border-left-color: #10b981; } .border-adequate { border-left-color: #f59e0b; } .border-developing { border-left-color: #f97316; } .border-needs-support { border-left-color: #ef4444; }
        .insight-positive { color: #10b981; }
        .insight-warning { color: #f59e0b; }
        .insight-negative { color: #ef4444; }
        
        /* Back Button */
        .back-button { display: none; padding: 12px 16px; background: #1e293b; border-bottom: 1px solid #334155; align-items: center; gap: 8px; cursor: pointer; color: #f97316; font-size: 14px; font-weight: 500; }
        .back-button:hover { background: #334155; }
        
        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .header { padding: 12px 16px; }
            .header h1 { font-size: 18px; }
            .header-stats { display: none; }
            
            .main-container { flex-direction: column; height: auto; min-height: calc(100vh - 60px); }
            
            .sidebar { width: 100%; border-right: none; border-bottom: 1px solid #334155; }
            .sidebar.has-selection .filter-section { display: none; }
            .sidebar.has-selection .quick-insights-toggle { display: none; }
            .sidebar.has-selection .quick-insights-content { display: none; }
            .sidebar.has-selection .trainer-list { display: none; }
            .sidebar.has-selection .back-button { display: flex; }
            
            .filter-section { padding: 12px; }
            .filter-select { padding: 10px; font-size: 13px; margin-bottom: 6px; }
            
            .quick-insights-toggle { display: block; }
            
            .trainer-list { max-height: 40vh; padding: 12px; }
            .trainer-card { padding: 10px; margin-bottom: 6px; }
            .trainer-card-name { font-size: 13px; }
            .trainer-card-score { font-size: 15px; }
            
            .main-panel { padding: 16px; }
            .main-panel.hidden { display: none; }
            
            .view-header { padding: 16px; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
            .view-title { font-size: 20px; }
            .score-circle { width: 70px; height: 70px; }
            .score-circle-value { font-size: 20px; }
            
            .tabs { gap: 4px; margin-bottom: 16px; overflow-x: auto; flex-wrap: nowrap; }
            .tab { padding: 10px 14px; font-size: 13px; white-space: nowrap; flex-shrink: 0; }
            
            .tab-content { padding: 16px; }
            .section-title { font-size: 15px; margin-bottom: 12px; }
            
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .stats-grid-item { padding: 12px; }
            .stats-grid-value { font-size: 22px; }
            
            .competency-item { grid-template-columns: 120px 1fr 50px; gap: 8px; margin-bottom: 10px; }
            .competency-label { font-size: 12px; }
            
            .comparison-grid { grid-template-columns: 1fr; }
            
            .rankings-header, .rankings-row { grid-template-columns: 35px 1fr 60px 70px; }
            .rankings-header span:nth-child(5), .rankings-row span:nth-child(5) { display: none; }
            
            .action-step { gap: 12px; padding: 14px; }
            .step-number { width: 28px; height: 28px; font-size: 12px; }
        }
        
        @media (min-width: 769px) {
            .back-button { display: none !important; }
            .quick-insights-toggle { display: none !important; }
            .quick-insights-content { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="app"><div class="loading"><div class="spinner"></div><p class="loading-text">Loading trainer data...</p></div></div>
    
    <script>
        const API_BASE_URL = 'https://trainer-performance-system.onrender.com';
        const API_USERNAME = 'educate';
        const API_PASSWORD = 'EBA_Uganda_2026';

        let state = {
            trainers: [],
            benchmarks: null,
            filters: null,
            selectedTrainer: null,
            trainerAnalysis: null,
            activeTab: 'overview',
            districtFilter: '',
            siteFilter: '',
            weekFilter: '',
            viewMode: 'list',
            quickInsightsExpanded: false
        };

        function getAuthHeader() { 
            return { 'Authorization': `Basic ${btoa(`${API_USERNAME}:${API_PASSWORD}`)}` }; 
        }

        async function apiFetch(endpoint) {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, { headers: getAuthHeader() });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        }

        async function loadData() {
            try {
                const [trainersData, benchmarksData, filtersData] = await Promise.all([
                    apiFetch('/api/trainers'),
                    apiFetch('/api/benchmarks'),
                    apiFetch('/api/filters')
                ]);
                state.trainers = trainersData.trainers || [];
                state.benchmarks = benchmarksData;
                state.filters = filtersData;
                render();
            } catch (error) {
                console.error('Failed to load data:', error);
                renderError('Failed to load data. Please wait 30 seconds and try again.');
            }
        }

        async function loadTrainerAnalysis(trainerId) {
            try {
                state.trainerAnalysis = await apiFetch(`/api/analyze/${trainerId}`);
                render();
            } catch (error) {
                console.error('Failed to load analysis:', error);
            }
        }

        function getScoreColor(score) {
            if (score >= 4.5) return 'exceptional';
            if (score >= 4.0) return 'strong';
            if (score >= 3.5) return 'adequate';
            if (score >= 3.0) return 'developing';
            return 'needs-support';
        }

        function getScoreLabel(score) {
            if (score >= 4.5) return 'Exceptional';
            if (score >= 4.0) return 'Strong';
            if (score >= 3.5) return 'Adequate';
            if (score >= 3.0) return 'Developing';
            return 'Needs Support';
        }

        function getFilteredTrainers() {
            return state.trainers.filter(t => {
                if (state.districtFilter && t.district_name !== state.districtFilter) return false;
                if (state.siteFilter && t.training_site !== state.siteFilter) return false;
                if (state.weekFilter && !t.observations?.some(o => o.week === state.weekFilter)) return false;
                return true;
            });
        }

        function getAvailableSites() {
            if (!state.filters?.sites) return [];
            if (!state.districtFilter) return state.filters.sites;
            return [...new Set(state.trainers.filter(t => t.district_name === state.districtFilter).map(t => t.training_site))].sort();
        }

        function getFilterContextName() {
            if (state.siteFilter) return state.siteFilter;
            if (state.districtFilter) return `${state.districtFilter} District`;
            return 'Program-Wide';
        }

        function getFilterContextIcon() {
            if (state.siteFilter) return 'üè´';
            if (state.districtFilter) return 'üìç';
            return 'üåç';
        }

        // =============================================================================
        // AGGREGATE ANALYTICS - FULL DETAIL
        // =============================================================================
        function calculateAggregateAnalytics() {
            const trainers = getFilteredTrainers();
            if (trainers.length === 0) return null;

            const scores = trainers.map(t => t.stats?.average_score || 0);
            const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;
            const totalObs = trainers.reduce((sum, t) => sum + (t.stats?.observations_count || 0), 0);
            const sortedTrainers = [...trainers].sort((a, b) => (b.stats?.average_score || 0) - (a.stats?.average_score || 0));
            
            const distribution = { exceptional: 0, strong: 0, adequate: 0, developing: 0, needsSupport: 0 };
            trainers.forEach(t => {
                const score = t.stats?.average_score || 0;
                if (score >= 4.5) distribution.exceptional++;
                else if (score >= 4.0) distribution.strong++;
                else if (score >= 3.5) distribution.adequate++;
                else if (score >= 3.0) distribution.developing++;
                else distribution.needsSupport++;
            });

            const trends = {
                improving: trainers.filter(t => t.stats?.trend === 'improving').length,
                declining: trainers.filter(t => t.stats?.trend === 'declining').length,
                stable: trainers.filter(t => t.stats?.trend === 'stable').length
            };

            const competencies = ['pck', 'fds', 'em', 'gr', 'cm', 'leadership'];
            const competencyNames = {
                'pck': 'Pedagogical Content Knowledge',
                'fds': 'Facilitation & Delivery Skills',
                'em': 'Entrepreneurship Mindset',
                'gr': 'Gender Responsiveness',
                'cm': 'Coaching & Mentoring',
                'leadership': 'Leadership'
            };
            
            const competencyData = {};
            competencies.forEach(comp => {
                let total = 0, count = 0;
                trainers.forEach(t => {
                    t.observations?.forEach(obs => {
                        if (obs[comp] && obs[comp] > 0) { total += obs[comp]; count++; }
                    });
                });
                competencyData[comp] = { name: competencyNames[comp], avg: count > 0 ? total / count : 0, count: count };
            });

            const sortedCompetencies = Object.entries(competencyData).sort((a, b) => b[1].avg - a[1].avg);
            const strongestComps = sortedCompetencies.slice(0, 2);
            const weakestComps = sortedCompetencies.slice(-2).reverse();

            const needsAttention = trainers.filter(t => (t.stats?.average_score || 0) < 3.0 || t.stats?.trend === 'declining');

            const genderStats = {};
            trainers.forEach(t => {
                const gender = t.trainer_gender || 'Unknown';
                if (!genderStats[gender]) genderStats[gender] = { count: 0, totalScore: 0 };
                genderStats[gender].count++;
                genderStats[gender].totalScore += t.stats?.average_score || 0;
            });
            Object.keys(genderStats).forEach(g => {
                genderStats[g].avg = genderStats[g].totalScore / genderStats[g].count;
            });

            return {
                trainerCount: trainers.length,
                observationCount: totalObs,
                avgScore: avgScore,
                minScore: Math.min(...scores),
                maxScore: Math.max(...scores),
                sortedTrainers: sortedTrainers,
                distribution: distribution,
                trends: trends,
                competencyData: competencyData,
                strongestCompetencies: strongestComps,
                weakestCompetencies: weakestComps,
                needsAttention: needsAttention,
                genderStats: genderStats
            };
        }

        function generateAggregateInsights(analytics) {
            if (!analytics) return null;
            
            const insights = { strengths: [], concerns: [], recommendations: [], actionPlan: [] };

            // Analyze strengths
            analytics.strongestCompetencies.forEach(([key, data]) => {
                if (data.avg >= 3.5) {
                    insights.strengths.push({
                        title: data.name,
                        score: data.avg,
                        text: `Strong performance across the group with an average of ${data.avg.toFixed(2)}/5.0. This is a collective strength to leverage.`
                    });
                }
            });

            if (analytics.trends.improving > 0) {
                insights.strengths.push({
                    title: `${analytics.trends.improving} Trainer${analytics.trends.improving > 1 ? 's' : ''} Improving`,
                    text: `Positive trajectory observed. Continue supporting these trainers to maintain momentum.`
                });
            }

            // Analyze concerns
            analytics.weakestCompetencies.forEach(([key, data]) => {
                if (data.avg < 3.5) {
                    insights.concerns.push({
                        title: data.name,
                        score: data.avg,
                        urgency: data.avg < 3.0 ? 'HIGH' : 'MEDIUM',
                        text: `Group average of ${data.avg.toFixed(2)}/5.0 indicates need for focused development.`
                    });
                }
            });

            if (analytics.trends.declining > 0) {
                insights.concerns.push({
                    title: `${analytics.trends.declining} Trainer${analytics.trends.declining > 1 ? 's' : ''} Declining`,
                    urgency: 'HIGH',
                    text: `Immediate intervention needed to reverse negative trends.`
                });
            }

            if (analytics.needsAttention.length > 0) {
                insights.concerns.push({
                    title: `${analytics.needsAttention.length} Trainer${analytics.needsAttention.length > 1 ? 's' : ''} Need Support`,
                    urgency: analytics.needsAttention.length > 3 ? 'HIGH' : 'MEDIUM',
                    text: `These trainers are scoring below 3.0 or showing declining trends: ${analytics.needsAttention.slice(0, 3).map(t => t.trainer_name).join(', ')}${analytics.needsAttention.length > 3 ? '...' : ''}`
                });
            }

            // Generate action plan
            let stepNum = 1;

            if (analytics.needsAttention.length > 0) {
                insights.actionPlan.push({
                    step: stepNum++,
                    priority: 'IMMEDIATE',
                    focus: 'Support Struggling Trainers',
                    timeline: 'This week',
                    actions: [
                        `Identify root causes for underperformance in ${analytics.needsAttention.length} trainer${analytics.needsAttention.length > 1 ? 's' : ''}`,
                        'Schedule individual check-ins with each trainer',
                        'Develop personalized improvement plans'
                    ],
                    metric: `Improve scores for ${analytics.needsAttention.length} trainers above 3.0`
                });
            }

            const weakest = analytics.weakestCompetencies[0];
            if (weakest && weakest[1].avg < 3.5) {
                insights.actionPlan.push({
                    step: stepNum++,
                    priority: 'SHORT-TERM',
                    focus: `Group Training: ${weakest[1].name}`,
                    timeline: 'Within 2 weeks',
                    actions: [
                        `Organize 2-hour workshop on ${weakest[1].name}`,
                        'Share best practices from top performers',
                        'Provide practical exercises and resources'
                    ],
                    metric: `Increase group average from ${weakest[1].avg.toFixed(2)} to ${Math.min(weakest[1].avg + 0.5, 4.0).toFixed(2)}`
                });
            }

            insights.actionPlan.push({
                step: stepNum++,
                priority: 'ONGOING',
                focus: 'Peer Learning & Recognition',
                timeline: 'Continuous',
                actions: [
                    `Pair top performers (${analytics.sortedTrainers.slice(0, 2).map(t => t.trainer_name).join(', ')}) with struggling trainers`,
                    'Recognize and celebrate improvements publicly',
                    'Create opportunities for best practice sharing'
                ],
                metric: 'Increase number of trainers in "Strong" or "Exceptional" categories'
            });

            return insights;
        }

        function calculateQuickInsights() {
            const trainers = getFilteredTrainers();
            if (trainers.length === 0) return null;

            const scores = trainers.map(t => t.stats?.average_score || 0);
            const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;
            const sortedTrainers = [...trainers].sort((a, b) => (b.stats?.average_score || 0) - (a.stats?.average_score || 0));
            
            return {
                count: trainers.length,
                avgScore: avgScore,
                topPerformer: sortedTrainers[0],
                needsSupport: trainers.filter(t => (t.stats?.average_score || 0) < 3.0).length,
                declining: trainers.filter(t => t.stats?.trend === 'declining').length,
                improving: trainers.filter(t => t.stats?.trend === 'improving').length
            };
        }

        // =============================================================================
        // EVENT HANDLERS
        // =============================================================================
        function selectTrainer(trainerId) {
            state.selectedTrainer = state.trainers.find(t => t.trainer_id === trainerId);
            state.trainerAnalysis = null;
            state.viewMode = 'trainer';
            state.activeTab = 'overview';
            loadTrainerAnalysis(trainerId);
            render();
        }

        function backToList() {
            state.selectedTrainer = null;
            state.trainerAnalysis = null;
            state.viewMode = 'list';
            render();
        }

        function showAggregateView() {
            state.selectedTrainer = null;
            state.trainerAnalysis = null;
            state.viewMode = 'aggregate';
            state.activeTab = 'overview';
            render();
        }

        function toggleQuickInsights() {
            state.quickInsightsExpanded = !state.quickInsightsExpanded;
            render();
        }

        function setTab(tab) {
            state.activeTab = tab;
            render();
        }

        function setDistrictFilter(value) {
            state.districtFilter = value;
            state.siteFilter = '';
            state.selectedTrainer = null;
            state.viewMode = 'list';
            render();
        }

        function setSiteFilter(value) {
            state.siteFilter = value;
            state.selectedTrainer = null;
            state.viewMode = 'list';
            render();
        }

        function setWeekFilter(value) {
            state.weekFilter = value;
            state.selectedTrainer = null;
            state.viewMode = 'list';
            render();
        }

        function clearFilters() {
            state.districtFilter = '';
            state.siteFilter = '';
            state.weekFilter = '';
            state.selectedTrainer = null;
            state.viewMode = 'list';
            render();
        }

        // =============================================================================
        // RENDER FUNCTIONS
        // =============================================================================
        function render() {
            const app = document.getElementById('app');
            const filteredTrainers = getFilteredTrainers();
            const availableSites = getAvailableSites();
            const quickInsights = calculateQuickInsights();
            const hasSelection = state.viewMode === 'trainer' || state.viewMode === 'aggregate';

            app.innerHTML = `
                <header class="header">
                    <div>
                        <h1>üéì Trainer Performance Dashboard</h1>
                        <p class="header-subtitle">E!BA Bootcamp 2025 - Educate!</p>
                    </div>
                    ${state.benchmarks ? `
                        <div class="header-stats">
                            <div class="stat-card" style="border-left-color: #3b82f6;">
                                <div class="stat-value">${state.benchmarks.program?.trainers || 0}</div>
                                <div class="stat-label">Trainers</div>
                            </div>
                            <div class="stat-card" style="border-left-color: #10b981;">
                                <div class="stat-value">${state.benchmarks.program?.observations || 0}</div>
                                <div class="stat-label">Observations</div>
                            </div>
                            <div class="stat-card" style="border-left-color: #f59e0b;">
                                <div class="stat-value">${state.benchmarks.program?.average?.toFixed(2) || '0'}</div>
                                <div class="stat-label">Avg Score</div>
                            </div>
                        </div>
                    ` : ''}
                </header>

                <div class="main-container">
                    <aside class="sidebar ${hasSelection ? 'has-selection' : ''}">
                        <div class="back-button" onclick="backToList()">‚Üê Back to Trainers</div>
                        
                        <div class="filter-section">
                            <div class="filter-title">Filters</div>
                            <select class="filter-select" onchange="setDistrictFilter(this.value)">
                                <option value="">All Districts</option>
                                ${state.filters?.districts?.map(d => `<option value="${d}" ${state.districtFilter === d ? 'selected' : ''}>${d}</option>`).join('') || ''}
                            </select>
                            <select class="filter-select" onchange="setSiteFilter(this.value)">
                                <option value="">All Sites</option>
                                ${availableSites.map(s => `<option value="${s}" ${state.siteFilter === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                            <select class="filter-select" onchange="setWeekFilter(this.value)">
                                <option value="">All Weeks</option>
                                ${state.filters?.weeks?.map(w => `<option value="${w}" ${state.weekFilter === w ? 'selected' : ''}>${w}</option>`).join('') || ''}
                            </select>
                            ${(state.districtFilter || state.siteFilter || state.weekFilter) ? `<button class="clear-btn" onclick="clearFilters()">Clear Filters</button>` : ''}
                            <button class="clear-btn" style="margin-top: 8px; background: #f97316; border-color: #f97316; color: white;" onclick="showAggregateView()">
                                üìä View ${getFilterContextName()} Insights
                            </button>
                        </div>

                        <!-- Mobile Quick Insights Toggle -->
                        ${quickInsights ? `
                            <div class="quick-insights-toggle" onclick="toggleQuickInsights()">
                                <div class="quick-insights-header">
                                    <div class="quick-insights-title">üí° ${getFilterContextName()}</div>
                                    <div class="quick-insights-summary">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value">${quickInsights.count}</div>
                                            <div class="quick-stat-label">Trainers</div>
                                        </div>
                                        <div class="quick-stat">
                                            <div class="quick-stat-value score-${getScoreColor(quickInsights.avgScore)}">${quickInsights.avgScore.toFixed(2)}</div>
                                            <div class="quick-stat-label">Avg</div>
                                        </div>
                                        <span class="toggle-arrow ${state.quickInsightsExpanded ? 'expanded' : ''}">‚ñº</span>
                                    </div>
                                </div>
                            </div>
                            <div class="quick-insights-content ${state.quickInsightsExpanded ? 'expanded' : ''}">
                                <div class="quick-insights-details">
                                    <div class="quick-insight-item">
                                        <span>üèÜ</span>
                                        <span>Top: <strong>${quickInsights.topPerformer?.trainer_name}</strong> (${quickInsights.topPerformer?.stats?.average_score?.toFixed(2)})</span>
                                    </div>
                                    ${quickInsights.needsSupport > 0 ? `
                                        <div class="quick-insight-item">
                                            <span>‚ö†Ô∏è</span>
                                            <span class="insight-warning">${quickInsights.needsSupport} need${quickInsights.needsSupport === 1 ? 's' : ''} support</span>
                                        </div>
                                    ` : `
                                        <div class="quick-insight-item">
                                            <span>‚úÖ</span>
                                            <span class="insight-positive">All above 3.0</span>
                                        </div>
                                    `}
                                    ${quickInsights.declining > 0 ? `
                                        <div class="quick-insight-item">
                                            <span>üìâ</span>
                                            <span class="insight-negative">${quickInsights.declining} declining</span>
                                        </div>
                                    ` : ''}
                                    ${quickInsights.improving > 0 ? `
                                        <div class="quick-insight-item">
                                            <span>üìà</span>
                                            <span class="insight-positive">${quickInsights.improving} improving</span>
                                        </div>
                                    ` : ''}
                                </div>
                                <button class="view-full-btn" onclick="showAggregateView()">View Full Analysis ‚Üí</button>
                            </div>
                        ` : ''}

                        <div class="trainer-list">
                            <div class="list-title"><span>Trainers (${filteredTrainers.length})</span></div>
                            ${filteredTrainers.map(t => `
                                <div class="trainer-card border-${getScoreColor(t.stats?.average_score || 0)} ${state.selectedTrainer?.trainer_id === t.trainer_id ? 'selected' : ''}" 
                                     onclick="selectTrainer('${t.trainer_id}')">
                                    <div class="trainer-card-name">${t.trainer_name}</div>
                                    <div class="trainer-card-meta">${t.district_name} ‚Ä¢ ${t.stats?.observations_count || 0} obs</div>
                                    <div class="trainer-card-score score-${getScoreColor(t.stats?.average_score || 0)}">
                                        ${t.stats?.average_score?.toFixed(2) || '0.00'}
                                        ${t.stats?.trend === 'improving' ? 'üìà' : t.stats?.trend === 'declining' ? 'üìâ' : '‚û°Ô∏è'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </aside>

                    <main class="main-panel ${state.viewMode === 'list' ? 'hidden' : ''}">
                        ${state.viewMode === 'trainer' && state.selectedTrainer ? renderTrainerView() : 
                          state.viewMode === 'aggregate' ? renderAggregateView() :
                          `<div class="placeholder"><h2>üëà Select a trainer</h2><p>Choose a trainer from the list to view details</p></div>`}
                    </main>
                </div>
            `;
        }

        // =============================================================================
        // AGGREGATE VIEW RENDERS - FULL DETAIL
        // =============================================================================
        function renderAggregateView() {
            const analytics = calculateAggregateAnalytics();
            if (!analytics) return `<div class="loading"><p class="loading-text">No trainers match the selected filters</p></div>`;

            const insights = generateAggregateInsights(analytics);

            return `
                <div class="view-header">
                    <div>
                        <div class="view-title">${getFilterContextIcon()} ${getFilterContextName()}</div>
                        <div class="view-subtitle">${analytics.trainerCount} Trainers ‚Ä¢ ${analytics.observationCount} Observations${state.weekFilter ? ` ‚Ä¢ ${state.weekFilter}` : ''}</div>
                    </div>
                    <div class="score-circle">
                        <span class="score-circle-value score-${getScoreColor(analytics.avgScore)}">${analytics.avgScore.toFixed(2)}</span>
                        <span class="score-circle-label">${getScoreLabel(analytics.avgScore)}</span>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab ${state.activeTab === 'overview' ? 'active' : ''}" onclick="setTab('overview')">Overview</button>
                    <button class="tab ${state.activeTab === 'comparisons' ? 'active' : ''}" onclick="setTab('comparisons')">Comparisons</button>
                    <button class="tab ${state.activeTab === 'insights' ? 'active' : ''}" onclick="setTab('insights')">AI Insights</button>
                </div>

                <div class="tab-content">
                    ${state.activeTab === 'overview' ? renderAggregateOverview(analytics) : ''}
                    ${state.activeTab === 'comparisons' ? renderAggregateComparisons(analytics) : ''}
                    ${state.activeTab === 'insights' ? renderAggregateInsights(analytics, insights) : ''}
                </div>
            `;
        }

        function renderAggregateOverview(analytics) {
            return `
                <!-- Key Statistics -->
                <div class="section">
                    <h3 class="section-title">üìä Key Statistics</h3>
                    <div class="stats-grid">
                        <div class="stats-grid-item">
                            <div class="stats-grid-value">${analytics.trainerCount}</div>
                            <div class="stats-grid-label">Total Trainers</div>
                        </div>
                        <div class="stats-grid-item">
                            <div class="stats-grid-value">${analytics.observationCount}</div>
                            <div class="stats-grid-label">Observations</div>
                        </div>
                        <div class="stats-grid-item">
                            <div class="stats-grid-value score-${getScoreColor(analytics.avgScore)}">${analytics.avgScore.toFixed(2)}</div>
                            <div class="stats-grid-label">Average Score</div>
                        </div>
                        <div class="stats-grid-item">
                            <div class="stats-grid-value">${analytics.maxScore.toFixed(2)} - ${analytics.minScore.toFixed(2)}</div>
                            <div class="stats-grid-label">Score Range</div>
                        </div>
                    </div>
                </div>

                <!-- Performance Distribution -->
                <div class="section">
                    <h3 class="section-title">üìà Performance Distribution</h3>
                    <div class="distribution-bar">
                        ${analytics.distribution.exceptional > 0 ? `<div class="distribution-segment bg-exceptional" style="width: ${(analytics.distribution.exceptional / analytics.trainerCount) * 100}%">${analytics.distribution.exceptional}</div>` : ''}
                        ${analytics.distribution.strong > 0 ? `<div class="distribution-segment bg-strong" style="width: ${(analytics.distribution.strong / analytics.trainerCount) * 100}%">${analytics.distribution.strong}</div>` : ''}
                        ${analytics.distribution.adequate > 0 ? `<div class="distribution-segment bg-adequate" style="width: ${(analytics.distribution.adequate / analytics.trainerCount) * 100}%">${analytics.distribution.adequate}</div>` : ''}
                        ${analytics.distribution.developing > 0 ? `<div class="distribution-segment bg-developing" style="width: ${(analytics.distribution.developing / analytics.trainerCount) * 100}%">${analytics.distribution.developing}</div>` : ''}
                        ${analytics.distribution.needsSupport > 0 ? `<div class="distribution-segment bg-needs-support" style="width: ${(analytics.distribution.needsSupport / analytics.trainerCount) * 100}%">${analytics.distribution.needsSupport}</div>` : ''}
                    </div>
                    <div class="distribution-legend">
                        <div class="legend-item"><div class="legend-dot bg-exceptional"></div>Exceptional (${analytics.distribution.exceptional})</div>
                        <div class="legend-item"><div class="legend-dot bg-strong"></div>Strong (${analytics.distribution.strong})</div>
                        <div class="legend-item"><div class="legend-dot bg-adequate"></div>Adequate (${analytics.distribution.adequate})</div>
                        <div class="legend-item"><div class="legend-dot bg-developing"></div>Developing (${analytics.distribution.developing})</div>
                        <div class="legend-item"><div class="legend-dot bg-needs-support"></div>Needs Support (${analytics.distribution.needsSupport})</div>
                    </div>
                </div>

                <!-- Competency Averages -->
                <div class="section">
                    <h3 class="section-title">üéØ Competency Averages</h3>
                    ${Object.entries(analytics.competencyData).sort((a, b) => b[1].avg - a[1].avg).map(([key, data]) => `
                        <div class="competency-item">
                            <div class="competency-label">${data.name}</div>
                            <div class="competency-bar">
                                <div class="competency-fill bg-${getScoreColor(data.avg)}" style="width: ${(data.avg / 5) * 100}%"></div>
                            </div>
                            <div class="competency-score score-${getScoreColor(data.avg)}">${data.avg.toFixed(2)}</div>
                        </div>
                    `).join('')}
                </div>

                <!-- Trainer Rankings -->
                <div class="section">
                    <h3 class="section-title">üèÜ Trainer Rankings</h3>
                    <div class="rankings-table">
                        <div class="rankings-header">
                            <span>Rank</span>
                            <span>Trainer</span>
                            <span>Score</span>
                            <span>Trend</span>
                            <span>Observations</span>
                        </div>
                        ${analytics.sortedTrainers.slice(0, 10).map((t, i) => `
                            <div class="rankings-row" onclick="selectTrainer('${t.trainer_id}')">
                                <span><div class="rank-badge ${i < 3 ? `rank-${i + 1}` : 'rank-other'}">${i + 1}</div></span>
                                <span>${t.trainer_name}</span>
                                <span class="score-${getScoreColor(t.stats?.average_score || 0)}">${t.stats?.average_score?.toFixed(2) || '0.00'}</span>
                                <span>${t.stats?.trend === 'improving' ? 'üìà Improving' : t.stats?.trend === 'declining' ? 'üìâ Declining' : '‚û°Ô∏è Stable'}</span>
                                <span>${t.stats?.observations_count || 0}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderAggregateComparisons(analytics) {
            const programAvg = state.benchmarks?.program?.average || analytics.avgScore;
            const currentAvg = analytics.avgScore;
            const diff = currentAvg - programAvg;

            const districtComparisons = [];
            if (state.benchmarks?.districts) {
                Object.entries(state.benchmarks.districts).forEach(([name, data]) => {
                    districtComparisons.push({ name, avg: data.average, trainers: data.trainers, isCurrent: name === state.districtFilter });
                });
                districtComparisons.sort((a, b) => b.avg - a.avg);
            }

            const genderComps = Object.entries(analytics.genderStats).map(([gender, data]) => ({
                name: gender, avg: data.avg, count: data.count
            }));

            return `
                <!-- vs Program Average -->
                <div class="section">
                    <h3 class="section-title">üåç vs Program Average</h3>
                    <div class="comparison-grid">
                        <div class="comparison-card">
                            <div class="comparison-header">
                                <span class="comparison-icon">${getFilterContextIcon()}</span>
                                <span class="comparison-label">${getFilterContextName()} vs Program</span>
                            </div>
                            <div class="comparison-scores">
                                <span class="comparison-main-score score-${getScoreColor(currentAvg)}">${currentAvg.toFixed(2)}</span>
                                <span class="comparison-vs">vs</span>
                                <span class="comparison-compare-score">${programAvg.toFixed(2)}</span>
                            </div>
                            <div class="comparison-bar-bg">
                                <div class="comparison-bar-fill" style="width: ${(currentAvg / 5) * 100}%; background: ${diff >= 0 ? '#10b981' : '#ef4444'}"></div>
                                <div class="comparison-marker" style="left: ${(programAvg / 5) * 100}%"></div>
                            </div>
                            <div class="comparison-meta">
                                <span style="color: ${diff >= 0 ? '#10b981' : '#ef4444'}">${diff >= 0 ? '+' : ''}${diff.toFixed(2)} ${diff >= 0 ? 'above' : 'below'} program</span>
                                <span>${analytics.trainerCount} of ${state.benchmarks?.program?.trainers || 0} trainers</span>
                            </div>
                        </div>

                        <div class="comparison-card">
                            <div class="comparison-header">
                                <span class="comparison-icon">üìà</span>
                                <span class="comparison-label">Trend Analysis</span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">
                                <div style="background: #064e3b; padding: 12px; border-radius: 6px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #10b981;">${analytics.trends.improving}</div>
                                    <div style="font-size: 11px; color: #94a3b8;">Improving</div>
                                </div>
                                <div style="background: #334155; padding: 12px; border-radius: 6px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #94a3b8;">${analytics.trends.stable}</div>
                                    <div style="font-size: 11px; color: #94a3b8;">Stable</div>
                                </div>
                                <div style="background: #7f1d1d; padding: 12px; border-radius: 6px;">
                                    <div style="font-size: 24px; font-weight: bold; color: #ef4444;">${analytics.trends.declining}</div>
                                    <div style="font-size: 11px; color: #94a3b8;">Declining</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- District Comparison -->
                ${districtComparisons.length > 1 ? `
                    <div class="section">
                        <h3 class="section-title">üìç District Comparison</h3>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${districtComparisons.map((d, i) => `
                                <div style="display: grid; grid-template-columns: 30px 1fr 60px 80px; gap: 12px; align-items: center; padding: 10px; background: ${d.isCurrent ? '#334155' : '#0f172a'}; border-radius: 6px; ${d.isCurrent ? 'border: 1px solid #f97316;' : ''}">
                                    <span style="font-weight: bold; color: ${i === 0 ? '#fbbf24' : '#94a3b8'};">#${i + 1}</span>
                                    <span style="font-weight: ${d.isCurrent ? '600' : '400'};">${d.name} ${d.isCurrent ? '(Current)' : ''}</span>
                                    <span class="score-${getScoreColor(d.avg)}" style="font-weight: bold;">${d.avg.toFixed(2)}</span>
                                    <span style="color: #64748b; font-size: 12px;">${d.trainers} trainers</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Gender Comparison -->
                ${genderComps.length > 0 ? `
                    <div class="section">
                        <h3 class="section-title">üë• Gender Breakdown</h3>
                        <div class="comparison-grid">
                            ${genderComps.map(g => `
                                <div class="comparison-card">
                                    <div class="comparison-header">
                                        <span class="comparison-icon">${g.name === 'Female' ? 'üë©' : 'üë®'}</span>
                                        <span class="comparison-label">${g.name} Trainers</span>
                                    </div>
                                    <div class="comparison-scores">
                                        <span class="comparison-main-score score-${getScoreColor(g.avg)}">${g.avg.toFixed(2)}</span>
                                    </div>
                                    <div class="comparison-meta">
                                        <span>${g.count} trainer${g.count !== 1 ? 's' : ''}</span>
                                        <span>${((g.count / analytics.trainerCount) * 100).toFixed(0)}% of group</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function renderAggregateInsights(analytics, insights) {
            if (!insights) return '<p>Unable to generate insights</p>';

            const urgencyLevel = analytics.needsAttention.length > 3 || analytics.trends.declining > 2 ? 'immediate' :
                                analytics.needsAttention.length > 0 || analytics.trends.declining > 0 ? 'short-term' : 'monitoring';
            const urgencyColor = urgencyLevel === 'immediate' ? '#ef4444' : urgencyLevel === 'short-term' ? '#f59e0b' : '#10b981';

            return `
                <!-- Executive Summary -->
                <div class="section">
                    <h3 class="section-title">üìã Executive Summary</h3>
                    <p style="line-height: 1.8; color: #cbd5e1;">
                        <strong>${getFilterContextName()}</strong> comprises <strong>${analytics.trainerCount} trainers</strong> with 
                        <strong>${analytics.observationCount} total observations</strong>. 
                        The group average score is <strong class="score-${getScoreColor(analytics.avgScore)}">${analytics.avgScore.toFixed(2)}/5.0 (${getScoreLabel(analytics.avgScore)})</strong>.
                        <br><br>
                        <strong>Performance Distribution:</strong> 
                        ${analytics.distribution.exceptional + analytics.distribution.strong} trainer${analytics.distribution.exceptional + analytics.distribution.strong !== 1 ? 's' : ''} (${(((analytics.distribution.exceptional + analytics.distribution.strong) / analytics.trainerCount) * 100).toFixed(0)}%) are performing at Strong or Exceptional levels, 
                        while ${analytics.distribution.developing + analytics.distribution.needsSupport} trainer${analytics.distribution.developing + analytics.distribution.needsSupport !== 1 ? 's' : ''} (${(((analytics.distribution.developing + analytics.distribution.needsSupport) / analytics.trainerCount) * 100).toFixed(0)}%) need additional support.
                        <br><br>
                        <strong>Trends:</strong> ${analytics.trends.improving} improving üìà, ${analytics.trends.stable} stable ‚û°Ô∏è, ${analytics.trends.declining} declining üìâ
                    </p>
                </div>

                <!-- Intervention Urgency -->
                <div class="section">
                    <h3 class="section-title">‚ö° Intervention Urgency</h3>
                    <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                        <span class="urgency-badge" style="background: ${urgencyColor}">${urgencyLevel.toUpperCase()}</span>
                        <span style="color: #94a3b8; font-size: 14px;">
                            ${urgencyLevel === 'immediate' ? 'Critical issues require immediate attention' :
                              urgencyLevel === 'short-term' ? 'Some trainers need focused support' :
                              'Continue regular monitoring and reinforcement'}
                        </span>
                    </div>
                </div>

                <!-- Key Strengths -->
                ${insights.strengths.length > 0 ? `
                    <div class="section">
                        <h3 class="section-title">üí™ Key Strengths</h3>
                        ${insights.strengths.map(s => `
                            <div class="insight-card strength">
                                <div class="insight-title strength">${s.title} ${s.score ? `(${s.score.toFixed(2)}/5.0)` : ''}</div>
                                <div class="insight-text">${s.text}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <!-- Areas of Concern -->
                ${insights.concerns.length > 0 ? `
                    <div class="section">
                        <h3 class="section-title">‚ö†Ô∏è Areas of Concern</h3>
                        ${insights.concerns.map(c => `
                            <div class="insight-card ${c.urgency === 'HIGH' ? 'danger' : 'warning'}">
                                <div class="insight-title ${c.urgency === 'HIGH' ? 'danger' : 'warning'}">
                                    ${c.title} ${c.score ? `(${c.score.toFixed(2)}/5.0)` : ''}
                                    ${c.urgency ? `<span style="font-size: 11px; padding: 2px 8px; border-radius: 10px; background: ${c.urgency === 'HIGH' ? '#ef4444' : '#f59e0b'}; color: white; margin-left: 8px;">${c.urgency}</span>` : ''}
                                </div>
                                <div class="insight-text">${c.text}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <!-- Action Plan -->
                ${insights.actionPlan.length > 0 ? `
                    <div class="section">
                        <h3 class="section-title">üìù Action Plan</h3>
                        <p style="color: #94a3b8; font-size: 14px; margin-bottom: 16px;">Recommended interventions for program managers:</p>
                        ${insights.actionPlan.map(step => `
                            <div class="action-step ${step.priority === 'IMMEDIATE' ? 'immediate' : step.priority === 'SHORT-TERM' ? 'short-term' : ''}">
                                <div class="step-number" style="background: ${step.priority === 'IMMEDIATE' ? '#ef4444' : step.priority === 'SHORT-TERM' ? '#f59e0b' : '#10b981'};">${step.step}</div>
                                <div class="step-content">
                                    <div class="step-header">
                                        <span class="step-priority" style="color: ${step.priority === 'IMMEDIATE' ? '#ef4444' : step.priority === 'SHORT-TERM' ? '#f59e0b' : '#10b981'};">${step.priority}</span>
                                        <span class="step-timeline">‚è±Ô∏è ${step.timeline}</span>
                                    </div>
                                    <div class="step-focus">${step.focus}</div>
                                    ${step.actions?.length ? `
                                        <div class="step-actions">
                                            <div class="step-actions-title">ACTION STEPS:</div>
                                            <ul class="step-actions-list">${step.actions.map(a => `<li>${a}</li>`).join('')}</ul>
                                        </div>
                                    ` : ''}
                                    ${step.metric ? `<div class="success-metric">üéØ Success Metric: ${step.metric}</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <!-- Trainers Needing Attention -->
                ${analytics.needsAttention.length > 0 ? `
                    <div class="section">
                        <h3 class="section-title">üö® Trainers Needing Immediate Attention</h3>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            ${analytics.needsAttention.map(t => `
                                <div style="display: grid; grid-template-columns: 1fr 70px 90px 100px; gap: 12px; align-items: center; padding: 12px; background: #7f1d1d33; border-radius: 6px; border-left: 4px solid #ef4444; cursor: pointer;" onclick="selectTrainer('${t.trainer_id}')">
                                    <span style="font-weight: 600;">${t.trainer_name}</span>
                                    <span class="score-${getScoreColor(t.stats?.average_score || 0)}" style="font-weight: bold;">${t.stats?.average_score?.toFixed(2) || '0.00'}</span>
                                    <span style="font-size: 12px;">${t.stats?.trend === 'declining' ? 'üìâ Declining' : '‚ö†Ô∏è Below 3.0'}</span>
                                    <span style="font-size: 12px; color: #94a3b8;">${t.training_site}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // =============================================================================
        // TRAINER VIEW RENDERS - FULL DETAIL
        // =============================================================================
        function renderTrainerView() {
            const t = state.selectedTrainer;
            return `
                <div class="view-header">
                    <div>
                        <div class="view-title">${t.trainer_name}</div>
                        <div class="view-subtitle">${t.trainer_gender} ‚Ä¢ ${t.district_name} ‚Ä¢ ${t.training_site}</div>
                    </div>
                    <div class="score-circle">
                        <span class="score-circle-value score-${getScoreColor(t.stats?.average_score || 0)}">${t.stats?.average_score?.toFixed(2) || '0'}</span>
                        <span class="score-circle-label">${getScoreLabel(t.stats?.average_score || 0)}</span>
                    </div>
                </div>
                <div class="tabs">
                    <button class="tab ${state.activeTab === 'overview' ? 'active' : ''}" onclick="setTab('overview')">Overview</button>
                    <button class="tab ${state.activeTab === 'comparisons' ? 'active' : ''}" onclick="setTab('comparisons')">Comparisons</button>
                    <button class="tab ${state.activeTab === 'insights' ? 'active' : ''}" onclick="setTab('insights')">AI Insights</button>
                </div>
                <div class="tab-content">
                    ${state.activeTab === 'overview' ? renderTrainerOverview() : ''}
                    ${state.activeTab === 'comparisons' ? renderTrainerComparisons() : ''}
                    ${state.activeTab === 'insights' ? renderTrainerInsights() : ''}
                </div>
            `;
        }

        function renderTrainerOverview() {
            const t = state.selectedTrainer;
            const latestObs = t.observations?.[t.observations.length - 1] || {};
            const competencies = [
                { key: 'pck', label: 'Pedagogical Content Knowledge' },
                { key: 'fds', label: 'Facilitation & Delivery Skills' },
                { key: 'em', label: 'Entrepreneurship Mindset' },
                { key: 'gr', label: 'Gender Responsiveness' },
                { key: 'cm', label: 'Coaching & Mentoring' },
                { key: 'leadership', label: 'Leadership' }
            ];

            return `
                <div class="section">
                    <h3 class="section-title">üìä Key Statistics</h3>
                    <div class="stats-grid">
                        <div class="stats-grid-item">
                            <div class="stats-grid-value">${t.stats?.observations_count || 0}</div>
                            <div class="stats-grid-label">Observations</div>
                        </div>
                        <div class="stats-grid-item">
                            <div class="stats-grid-value score-${getScoreColor(t.stats?.average_score || 0)}">${t.stats?.average_score?.toFixed(2) || '0'}</div>
                            <div class="stats-grid-label">Average Score</div>
                        </div>
                        <div class="stats-grid-item">
                            <div class="stats-grid-value">${t.stats?.trend === 'improving' ? 'üìà' : t.stats?.trend === 'declining' ? 'üìâ' : '‚û°Ô∏è'}</div>
                            <div class="stats-grid-label">${t.stats?.trend?.charAt(0).toUpperCase() + t.stats?.trend?.slice(1) || 'Stable'}</div>
                        </div>
                        <div class="stats-grid-item">
                            <div class="stats-grid-value" style="font-size: 18px;">${getScoreLabel(t.stats?.average_score || 0)}</div>
                            <div class="stats-grid-label">Performance Level</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">üéØ Competency Scores (Latest Observation)</h3>
                    ${competencies.map(c => `
                        <div class="competency-item">
                            <div class="competency-label">${c.label}</div>
                            <div class="competency-bar">
                                <div class="competency-fill bg-${getScoreColor(latestObs[c.key] || 0)}" style="width: ${((latestObs[c.key] || 0) / 5) * 100}%"></div>
                            </div>
                            <div class="competency-score score-${getScoreColor(latestObs[c.key] || 0)}">${(latestObs[c.key] || 0).toFixed(2)}</div>
                        </div>
                    `).join('')}
                </div>

                <div class="section">
                    <h3 class="section-title">üìÖ Observation History</h3>
                    <div class="history-header"><span>Date</span><span>Week</span><span>Observer</span><span>Score</span></div>
                    ${t.observations?.map(o => `
                        <div class="history-row">
                            <span>${o.date || '-'}</span>
                            <span>${o.week || '-'}</span>
                            <span>${o.observer || '-'}</span>
                            <span class="score-${getScoreColor(o.overall_score)}">${o.overall_score?.toFixed(2) || '-'}</span>
                        </div>
                    `).join('') || '<p style="color: #64748b; padding: 16px 0;">No observations recorded</p>'}
                </div>
            `;
        }

        function renderTrainerComparisons() {
            if (!state.trainerAnalysis) return '<div class="loading"><div class="spinner"></div><p class="loading-text">Loading comparisons...</p></div>';

            const comparisons = [
                { key: 'program', label: 'Program-Wide', icon: 'üåç' },
                { key: 'district', label: `District (${state.trainerAnalysis.comparisons?.district?.name || ''})`, icon: 'üìç' },
                { key: 'site', label: 'Site', icon: 'üè´' },
                { key: 'gender', label: `Gender (${state.trainerAnalysis.comparisons?.gender?.group || ''})`, icon: 'üë•' }
            ];

            return `
                <div class="section">
                    <h3 class="section-title">üìä Performance Comparisons</h3>
                    <div class="comparison-grid">
                        ${comparisons.map(c => {
                            const data = state.trainerAnalysis.comparisons?.[c.key];
                            if (!data) return '';
                            const diffColor = data.diff >= 0 ? '#10b981' : '#ef4444';
                            
                            return `
                                <div class="comparison-card">
                                    <div class="comparison-header">
                                        <span class="comparison-icon">${c.icon}</span>
                                        <span class="comparison-label">${c.label}</span>
                                    </div>
                                    <div class="comparison-scores">
                                        <span class="comparison-main-score">${data.trainer_avg}</span>
                                        <span class="comparison-vs">vs</span>
                                        <span class="comparison-compare-score">${data.avg}</span>
                                    </div>
                                    <div class="comparison-bar-bg">
                                        <div class="comparison-bar-fill" style="width: ${(data.trainer_avg / 5) * 100}%; background: ${diffColor}"></div>
                                        <div class="comparison-marker" style="left: ${(data.avg / 5) * 100}%"></div>
                                    </div>
                                    <div class="comparison-meta">
                                        <span style="color: ${diffColor}">${data.diff >= 0 ? '+' : ''}${data.diff}</span>
                                        ${data.rank ? `<span>Rank #${data.rank} of ${data.total}</span>` : ''}
                                        ${data.percentile !== undefined ? `<span>${data.percentile}th %ile</span>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderTrainerInsights() {
            if (!state.trainerAnalysis) return '<div class="loading"><div class="spinner"></div><p class="loading-text">Loading AI insights...</p></div>';

            const a = state.trainerAnalysis;
            const urgencyColor = a.intervention_urgency === 'immediate' ? '#ef4444' : a.intervention_urgency === 'short-term' ? '#f59e0b' : '#10b981';

            return `
                <div class="section">
                    <h3 class="section-title">üìã Executive Summary</h3>
                    <p style="line-height: 1.6; color: #cbd5e1;">${a.executive_summary || 'No summary available'}</p>
                </div>

                <div class="section">
                    <h3 class="section-title">‚ö° Intervention Urgency</h3>
                    <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                        <span class="urgency-badge" style="background: ${urgencyColor}">${(a.intervention_urgency || 'monitoring').toUpperCase()}</span>
                        <span style="color: #94a3b8; font-size: 14px;">${a.urgency_rationale || ''}</span>
                    </div>
                </div>

                ${a.key_strengths?.length ? `
                    <div class="section">
                        <h3 class="section-title">üí™ Key Strengths</h3>
                        ${a.key_strengths.map(s => `
                            <div class="insight-card strength">
                                <div class="insight-title strength">${s.competency} ${s.average_score ? `(${s.average_score}/5.0)` : ''}</div>
                                <div class="insight-text">${s.analysis}</div>
                                ${s.example ? `<div style="color: #94a3b8; font-size: 13px; margin-top: 8px; font-style: italic;">"${s.example}"</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${a.development_areas?.length ? `
                    <div class="section">
                        <h3 class="section-title">üéØ Development Areas</h3>
                        ${a.development_areas.map(d => `
                            <div class="insight-card ${d.urgency === 'HIGH' ? 'danger' : d.urgency === 'MEDIUM' ? 'warning' : 'info'}">
                                <div class="insight-title ${d.urgency === 'HIGH' ? 'danger' : d.urgency === 'MEDIUM' ? 'warning' : 'info'}">
                                    ${d.competency} ${d.average_score ? `(${d.average_score}/5.0)` : ''}
                                    ${d.urgency ? `<span style="font-size: 11px; padding: 2px 8px; border-radius: 10px; background: ${d.urgency === 'HIGH' ? '#ef4444' : d.urgency === 'MEDIUM' ? '#f59e0b' : '#6b7280'}; color: white; margin-left: 8px;">${d.urgency}</span>` : ''}
                                </div>
                                <div class="insight-text">${d.analysis}</div>
                                ${d.example ? `<div style="color: #94a3b8; font-size: 13px; margin-top: 8px; font-style: italic;">"${d.example}"</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${a.improvement_plan?.length ? `
                    <div class="section">
                        <h3 class="section-title">üìù Improvement Plan for Observer</h3>
                        <p style="color: #94a3b8; font-size: 14px; margin-bottom: 16px;">Use this plan when coaching the trainer:</p>
                        ${a.improvement_plan.map(step => `
                            <div class="action-step ${step.priority === 'IMMEDIATE' ? 'immediate' : step.priority === 'SHORT-TERM' ? 'short-term' : ''}">
                                <div class="step-number" style="background: ${step.priority === 'IMMEDIATE' ? '#ef4444' : step.priority === 'SHORT-TERM' ? '#f59e0b' : step.priority === 'LEVERAGE STRENGTH' ? '#10b981' : '#f97316'};">${step.step}</div>
                                <div class="step-content">
                                    <div class="step-header">
                                        <span class="step-priority" style="color: #f97316;">${step.priority || ''}</span>
                                        ${step.timeline ? `<span class="step-timeline">‚è±Ô∏è ${step.timeline}</span>` : ''}
                                    </div>
                                    <div class="step-focus">${step.focus_area || ''}</div>
                                    ${step.current_score ? `<div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px;">Current: ${step.current_score}/5.0 ‚Üí Target: ${step.target_score}/5.0</div>` : ''}
                                    ${step.diagnosis ? `<div class="step-diagnosis">${step.diagnosis}</div>` : ''}
                                    ${step.actions?.length ? `
                                        <div class="step-actions">
                                            <div class="step-actions-title">ACTION STEPS:</div>
                                            <ul class="step-actions-list">${step.actions.map(a => `<li>${a}</li>`).join('')}</ul>
                                        </div>
                                    ` : ''}
                                    ${step.coaching_tip ? `
                                        <div class="coaching-tip">
                                            <span class="coaching-tip-label">üí° Coaching Tip:</span>
                                            <span class="coaching-tip-text">${step.coaching_tip}</span>
                                        </div>
                                    ` : ''}
                                    ${step.success_metric ? `<div class="success-metric">üéØ Success Metric: ${step.success_metric}</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${a.observer_action_items?.length ? `
                    <div class="section">
                        <h3 class="section-title">‚úÖ Observer Action Items</h3>
                        <div class="insight-card info">
                            <ul style="margin: 0; padding-left: 20px;">
                                ${a.observer_action_items.map(item => `<li style="margin-bottom: 8px;">${item}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function renderError(message) {
            document.getElementById('app').innerHTML = `
                <div class="error-container">
                    <h2>‚ö†Ô∏è Connection Error</h2>
                    <p>${message}</p>
                    <button class="retry-btn" onclick="location.reload()">Retry</button>
                </div>
            `;
        }

        loadData();
    </script>
</body>
</html>
